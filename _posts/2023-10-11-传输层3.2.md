---
layout: post
title: 3.2 多路复用与解复用
subtitle: 计网笔记
author: NightSheep
categories: 计网笔记
tags:
  - 笔记
  - 计网
---
## 多路复用与解复用
---
### 概念

- 在发送方主机**多路复用**
	- 从多个套接字接收来自多个进程的报文，根据套接字对应的**IP地址和端口号**等信息对报文段用头部加以封装（该头部信息用于之后的解复用）  

- 在接收方主机**多路解复用**
	- 根据报文段的头部信息中的**IP地址和端口号**将接收到的报文段发给正确的套接字（和对应的应用进程）  

### 工作原理

**解复用作用**：TCP或UDP实体采用哪些信息，将段的数据部分交给正确的socket，从而交给正确的进程  

- 主机收到IP数据报：
	- 每个IP数据报有源IP地址和目标IP地址
	- IP数据报承载一个传输层报文段，每个段有一个源端口号和目标端口号
	- 主机联合使用**IP和端口号**将报文段发送给合适的套接字，交给相应的进程(线程)
		- TCP使用四元组
		- UDP使用二元组（目标IP、目标port）

## UDP多路解复用
---
### 创建套接字

**服务器端**
```cpp
serverSocket=socket(PF_INET,SOCK_DGRAM,0);
bind(serverSocket,&sad,sizeof(sad));//serverSocket和Sad指定的端口号捆绑
```
**客户端**
```cpp
ClientSocket=socket(PF_INET,SOCK_DGRAM,0);//没Bind,ClientSocket和OS为之分配的某个端口号捆绑（客户端使用什么端口号无所谓，客户端主动找服务器）
```

### 解复用过程

在接收端，UDP套接字用二元组标识(**目标IP地址、目标端口号**)  

- 当主机收到UDP报文段：
	- 检查报文段的目标端口号
	- 用该端口号将报文段定位给套接字  

如果两个不同源IP地址/源端口号的数据报，但是有**相同的目标IP地址和端口号**，则被定位到相同的套接字

## TCP多路解复用
---
### 解复用过程

- TCP套接字使用四元组本地标识：
	- 源IP地址
	- 源端口号
	- 目的IP地址
	- 目的端口号

**解复用**：接收主机用这四个值来将数据报定位到合适的套接字  

服务器能够在一个TCP端口上同时支持多个TCP套接字：
- 每个套接字由其四元组标识，只要四元组任意一个值不同，对应的socket就不同（有不同的源IP和源PORT）  

### 多线程Web Server

>一个进程下面可能有多个线程，由多个线程分别为客户提供服务。根据4元组决定将报文段内容分发至同一个进程下的不同线程

