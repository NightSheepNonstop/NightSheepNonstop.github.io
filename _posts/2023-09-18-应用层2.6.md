---
layout: post
title: 2.6 P2P应用
subtitle: 计网笔记
author: NightSheep
categories: 计网笔记
tags: [笔记,计网]
---
## 纯P2P架构
---

- 没有（或极少）一直运行的服务器
- 任意端系统都可以直接通信
- 利用peer（对等体）的服务能力
- peer节点间歇上网，每次IP地址都有可能变化

## P2P文件分发
---

### C/S vs P2P

- **C/S模式**：
	- **服务器传输**： 都是由服务器发送给peer，服务器必须顺序传输（上载）N个文件拷贝:
		- 发送一个拷贝：$F/u_s$
		- 发送N个拷贝：$NF/u_s$
	- **客户端**：每个客户端必须下载一个文件拷贝
		- 将客户端最小的下载速率记为$d_{min}$
		- 下载带宽最小的客户端下载的时间：$F/d_{min}$
	- 将一个F大小的文件分发给N个客户端耗时：$D_{c/s}\geq max\{NF/u_s,F/d_{min}\}$
- **P2P模式**：
	- **服务器传输**：最少需要上载一份拷贝
		- 发送一个拷贝：$F/u_s$
	- **客户端**：每个客户端必须下载一个拷贝
		- 下载带宽最小的客户端下载的时间：$F/d_{min}$
	- **客户端**：所有客户端的总体下载量为NF
		- 最大上载带宽为：$u_s+\sum u_i$
		- 除了服务器可以上载，其他所有peer节点都可以上载
	- 将一个F大小的文件分发给N个客户端耗时：$D_{P2P}\geq max\{F/u_s,F/d_{min},NF/(u_s+\sum u_i\}$
- **比较结果**：
	- 随着N的增大，C/S模式的耗时线性增长，而P2P模式耗时增长较慢![C/S vs P2P](/assets/images/Snipaste_2023-09-18_21-23-52.png)

### BitTorrent

- 文件被分为一个个块（典型的块长度为256KB）
- 洪流(*Torrent*)：参与一个特定文件分发的所有peer的集合
- 洪流中的这些peer发送接收文件块，相互服务
- 跟踪服务器(*tracker*)：跟踪洪流中的参与节点

- 当peer下载时，该peer可以同时向其他节点提供上载服务
- peer可能会变换用于交换块的peer节点
- 扰动（*churn*）：peer节点可能会上线或者下线
- 一旦一个peer拥有整个文件，它会（自私地）离开或者保留（利他主义）在洪流中

- **peer加入洪流**
	- 为便于叙述，将该peer节点记为A
	- 一开始没有块，但是将会通过其他节点处累积文件块
	- 向跟踪服务器注册，获得peer节点列表，和部分peer节点构成邻居关系（”连接“）
- **请求块**
	- 在任何给定时间，不同peer节点拥有一个文件块的子集
	- 周期性的，A节点向邻居询问他们拥有哪些块的信息
	- A向peer节点请求它希望的块，**稀缺**的块
- **发送块**：一报还一报(*tit-for-tat*)
	- A向4个peer发送块，这些块向A提供最大带宽的服务
		- 其他peer被A阻塞（将不会从A处获得服务）
		- 每10秒重新评估一次：前4位（这四个peer被称为“疏通”）
	- 每个30秒：随机选择其他peer节点，向这个节点发送块
		- “优化疏通” 这个节点
			- A 优化疏通 B
			- A变成了B的TOP4，B答谢A（B对A的带宽增大）
			- B变成了A的TOP4

## P2P文件共享
---

- **可扩展性好**
	- 所有的peer都是服务器

- **两个问题**：
	- 如何定位所需资源
	- 如何处理对等方的加入与离开
- 可能的解决方案：
	- 非结构化P2P
		- 集中：集中式目录
		- 分散：查询洪泛
		- 半分散：利用不匀称性等
	- 结构化P2P
		- DHT[^1]

### 集中式目录：Napster

- 最初的Napster设计
	1. 当对等方连接时，它告知中心服务器：
		- IP地址
		- 内容
	2. A查询文件，服务器告知B有该文件
	3. A从B处请求文件
- 集中式目录的问题：
	- 单点故障
		- 中心服务器瘫痪则整个共享系统瘫痪
	- 性能瓶颈
		- 查询时间受中心服务器性能限制
	- 侵犯版权

### 查询洪泛：Gnutella

- 全分布式
	- 没有中心服务器
- 开放文件共享协议
- 许多Gnutella客户端实现了Gnutella协议
	- 类似HTTP有许多的浏览器

- **覆盖网络**：
	- 如果X和Y之间有一个TCP连接，则二者之间存在一条边
		- 边并不是物理链路，而是逻辑上的
	- 所有活动的对等方和边就是覆盖网络
	- 给定一个对等方，通常所连接的节点少于10个

- **Gnutella协议**：
	- 在已有的TCP连接上发送查询报文
	- 对等方转发查询报文
	- 以反方向返回查询命中报文

- **对等方加入**：
	1. 对等方X必须首先发现某些已经在覆盖网络中的其他对等方：使用可用对等方列表
		- 自己维持一张对等方列表（经常开机的对等方的IP）联系维持列表的Gnutella站点
	2. X接着试图与该列表上的对等方建立TCP连接，直到与某个对等方Y建立连接
	3. X向Y发送一个Ping报文，Y转发该Ping报文
	4. 所有收到Ping报文的对等方以Pong报文响应
		- IP地址、共享文件的数量及总字节数
	5. X收到许多Pong报文，然后它能建立其他TCP连接

### 利用不匀称性：KaZaA

- 每个对等方要么是一个组长，要么隶属于一个组长
	- 对等方与其组长之间有TCP连接
	- 组长对之间有TCP连接
- 组长跟踪其所有的孩子的内容
- 组长与其他组长联系
	- 转发查询到其他组长
	- 获得其他组长的数据拷贝

- **查询**：
	- 每个文件有一个散列标识码和一个描述符
	- 客户端向其组长发送关键字查询
	- 组长用匹配进行响应：
		- 对每个匹配：元数据、散列标识码和IP地址
	- 如果组长将查询转发给其他组长，其他组长也以匹配进行响应
	- 客户端选择要下载的文件
		- 向拥有文件的对等方发送一个带散列标识码的HTTP请求

- **小技巧**：
	- 请求排队
		- 限制并行上载的数量
		- 确保每个被传输的文件从上载节点接收一定量的带宽
	- 激励优先权
		- 鼓励用户上载文件
		- 加强系统的扩展性
	- 并行下载
		- 从多个对等方下载同一个文件的不同部分

## 名词解释
---

[^1]: DHT: *Distributed Hash Table* 分布式散列表